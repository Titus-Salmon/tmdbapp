<!DOCTYPE html>
<html>

<head>
    <title>{{title}}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta charset="UTF-8">

    <!--<link rel="stylesheet" href="../stylesheets/style.css" />-->
    <!--<link rel="stylesheet" href="../stylesheets/jstyle.css" />-->

    <script src="tablefilter/dist/tablefilter/tablefilter.js"></script>

</head>

<body>

    {{> header }}

    <div id="search-form">
        <div class="scan-fields">
            <label class="label-class" for="social-security">SSN</label>
            <input class="input-class" id="social-security" type="text" name="ssn">
        </div>
        <div class="scan-fields">
            <label class="label-class" for="dob">DOB</label>
            <input class="input-class" id="dob" type="date" name="dob">
        </div>
        <div class="scan-fields">
            <label class="label-class" for="last-name">Last Name</label>
            <input class="input-class" id="last-name" type="text" name="lname">
        </div>
        <div class="scan-fields">
            <label class="label-class" for="first-name">First Name</label>
            <input class="input-class" id="first-name" type="text" name="fname">
        </div>
        <div class="scan-fields">
            <label class="label-class" for="occupation">Occupation</label>
            <input class="input-class" id="occupation" type="text" name="occupation">
        </div>
        <div class="scan-fields">
            <label class="label-class" for="emp">Employer</label>
            <input class="input-class" id="emp" type="text" name="employer">
        </div>
        <div class="scan-fields">
            <label class="label-class" for="application-date">Application Date</label>
            <input class="input-class" id="application-date" type="date" name="date">
        </div>

        <div class="scan-fields">
            <button type="button" style="margin-top:1.2em" onclick="clearTable(); clearCaption(); showScanResults()">Search</button>
        </div>
    </div>

    <table id="resultsTable">
        <thead>
            <tr style="background-color: #f2f2f2 !important">
                <th>SSN</th>
                <th>DOB</th>
                <th>Last Name</th>
                <th>First Name</th>
                <th>Occupation</th>
                <th>Employer</th>
                <th>Application Date</th>
            </tr>
        </thead>
        <tbody id="resultsTableBody">
            <tr style="display:none">
                <th></th>
                <th></th>
                <th></th>
                <th></th>
                <th></th>
                <th></th>
                <th></th>

            </tr>
        </tbody>
    </table>

    <!--<script src="javascripts/sortAndPag-t0d.js"></script>-->

    <script>
        function clearTable() {
            //if table has any data in it
            if (document.getElementById("resultsTableBody").rows[0].cells.length > 0) {
                //clear the table
                var tableBody = document.getElementById("resultsTableBody");
                tableBody.innerHTML = "";
            }
        }

        function clearCaption() {
            document.getElementById("resultsTable").deleteCaption();
        }

        function showScanResults() {
            var soc = document.getElementById("social-security").value;
            var dob = document.getElementById("dob").value;
            var lastName = document.getElementById("last-name").value;
            var firstName = document.getElementById("first-name").value;
            var occ = document.getElementById("occupation").value;
            var empl = document.getElementById("emp").value;
            var appDate = document.getElementById("application-date").value;
            var ajaxCall = new XMLHttpRequest();
            ajaxCall.onreadystatechange = function () {
                if (ajaxCall.readyState == 4 && ajaxCall.status == 200) {
                    console.log('ajaxCall.responseText = ');
                    console.log(ajaxCall.responseText);
                    var jsonParsedData = ajaxCall.responseText;
                    var jsonResponse = JSON.parse(jsonParsedData);
                    console.log('jsonResponse =');
                    console.log(jsonResponse);
                    jsonResponse.forEach((i) => {//for each element of the jsonResponse array,
                        //get corresponding string entered in the application form
                        console.log("*************************************************");
                        console.log('~~~~~> i =')
                        console.log(i);
                        i.forEach((n) => {
                            console.log('///////////////////');
                            console.log(n);
                            var dob_entry = n['dob']['S'];
                            var ssn_entry = n['ssn']['S'];
                            var lname_entry = n['lname']['S'];
                            var fname_entry = n['fname']['S'];
                            var occ_entry = n['occupation']['S'];
                            var empl_entry = n['employer']['S'];
                            var appDate_entry = n['date']['S'];
                            var tableBody = document.getElementById("resultsTableBody");
                            var row = tableBody.insertRow(-1);
                            var cellSSN = row.insertCell(-1);
                            var cellDOB = row.insertCell(-1);
                            var cellLname = row.insertCell(-1);
                            var cellFname = row.insertCell(-1);
                            var cellOcc = row.insertCell(-1);
                            var cellEmp = row.insertCell(-1);
                            var cellAppDate = row.insertCell(-1);
                            cellSSN.innerHTML = ssn_entry;
                            cellDOB.innerHTML = dob_entry;
                            cellLname.innerHTML = lname_entry;
                            cellFname.innerHTML = fname_entry;
                            cellOcc.innerHTML = occ_entry;
                            cellEmp.innerHTML = empl_entry;
                            cellAppDate.innerHTML = appDate_entry;
                        });
                    });
                    /*******tablefilter.js*************************************************************/
                    var tf = new TableFilter('resultsTable', {
                        base_path: 'tablefilter/dist/tablefilter/',
                        extensions: [{
                            name: 'sort',
                            types: ['string', 'string', 'string', 'string', 'string', 'string', 'string'],
                            //    on_sort_loaded: startSimple,
                            on_before_sort: function (o, col) {
                                outputBefore = [o, col];
                            },
                            on_after_sort: function (o, col) {
                                outputAfter = [o, col];
                            }
                        }],
                        paging: {
                            length: 20,
                            //results_per_page: ['Results per page ', [5, 10, 15, 20, 25, 30, 35, 40, 45, 50]]
                        }
                    });
                    tf.init();
                    /*******tablefilter.js*************************************************************/
                    var caption = document.getElementsByTagName("caption");
                    var tbl = document.getElementById("resultsTable");
                    var filterRow = tbl.childNodes[2].childNodes[1];

                        if (tbl.childNodes[2].childNodes.length > 4) {//if there is more than 1 <tr class="fltrow"></tr>
                            tbl.childNodes[2].removeChild(filterRow); //delete it
                        }
                    
                    console.log('tbl.childNodes = ');
                    console.log(tbl.childNodes);
                    console.log('tbl.childNodes[2] = ');
                    console.log(tbl.childNodes[2]);
                    console.log('tbl.childNodes[2].childNodes = ');
                    console.log(tbl.childNodes[2].childNodes);
                    console.log('tbl.childNodes[2].childNodes[1] = ');
                    console.log(tbl.childNodes[2].childNodes[1]);
                    console.log('tbl.childNodes[2].childNodes.length = ');
                    console.log(tbl.childNodes[2].childNodes.length);
                }
            };


            ajaxCall.open("POST", "/scan/results", true);
            console.log('post request sent from scan.hbs')
            ajaxCall.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
            ajaxCall.send("ssn=" + soc + "&dob=" + dob + "&lname=" + lastName + "&fname=" + firstName + "&occupation=" + occ + "&employer=" + empl + "&date=" + appDate);

        }

    </script>

    <!--<script src="javascripts/sortAndPag-t0d.js"></script>-->

</body>

</html>